
<!DOCTYPE html>
<html>
<head>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
  <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
  <script src="https://sdk.scdn.co/spotify-player.js"></script>

  <title>Jukeboxd Player</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="background-style.css">
  <link rel="stylesheet" href="styles.css">
  <script>
      //jQuery stuff
      $(document).ready(function(){
        var childDiv = $(".hiddenFormMouseover");
        var throttle;
        var fadingIn = false;
        var isMouseOver = false;

        $(document).mousemove(function(event) {
            clearTimeout(throttle);

            if (!fadingIn && !isMouseOver) {
                fadingIn = true;
                childDiv.stop(true).fadeTo(500, 1, function() {
                    fadingIn = false;
                });
            }

            throttle = setTimeout(function() {
                if (!isMouseOver) {
                    childDiv.fadeTo(1000, 0.2);
                }
            }, 3000);
        });

        childDiv.mouseover(function() {
            $(this).stop().fadeTo(500, 1);
            clearTimeout(throttle);
            isMouseOver = true;
        });

        childDiv.mouseout(function() {
            throttle = setTimeout(function() {
                if (!isMouseOver) {
                    childDiv.fadeTo(1000, 0.2);
                }
            }, 3000);
            isMouseOver = false;
        });
      });
  </script>
</head>

<body class="d-flex h-100 text-center text-white bg-dark">
  <div class="cover-container d-flex w-100 h-100 p-3 mx-auto flex-column">
      <header class="mb-auto">
        <div>
          <nav class="nav nav-masthead justify-content-center float-md-start">
            <div class="input-group">
              <div class="input-group mb-3 searchbar hiddenFormMouseover">
                          <input type="text" class="form-control" placeholder="Search songs..." aria-label="Song Name" aria-describedby="basic-addon1">
                <div class="input-group-append">
                  <button class="btn btn-primary" type="button">Search</button>
                </div>
              </div>
            </div>
          </nav>
        </div>
      </header>
    
      <main class="px-3">
        <div id="loggedin">
          <div id="user-profile">
          </div>
          <div id="oauth">
          </div>
          <button class="btn btn-default" id="obtain-new-token"></button>
        </div>
        <p id="currentlyPlaying"></p>
        <img id="currentTrackImage" src="" alt="" width="200px" height="200px"><br>
        <img id="previousTrack" src="./imgs/previous-removebg-preview.png" class="next-button" />
        <img id="togglePlay" src="./imgs/play2-removebg-preview.png" class="play-button" />
        <img id="nextTrack" src="./imgs/next-removebg-preview.png" class="previous-button" />
        <br>
        <div class="progress-container">
          <span class="timestamp" id="current-time">0:00</span>
          <div class="progress-bar-container">
            <div class="progress-bar" id="progress-bar"></div>
          </div>
          <span class="timestamp" id="total-duration">0:00</span>
        </div>
        <br>

        <div class="container hiddenFormMouseover">
          <div class="row justify-content-md-center">
            <div class="col-md-auto">
              <label>Add Comment:</label>
            </div>
          </div>
          <div class="row justify-content-md-center">
            <div class="col-md-auto">
              <div class="input-group mb-3">
                <input id="commentInput" type="text" class="form-control" placeholder="Type here..." aria-label="Add comments" aria-describedby="basic-addon2">
                <div class="input-group-append">
                  <button class="btn btn-secondary" type="button">Post</button>
                </div>
              </div>
            </div>
          </div>
          <div class="row justify-content-md-center">
            <div class="col-md-auto">
              <label>Toggle Comments:</label>
            </div>
          </div>
          <div class="row justify-content-md-center">
            <div class="col-md-auto">
              <!-- Toggle User comments, all comments, no comments. Ajax to refresh the page comments immediately? -->

              <div class="input-group mb-3">
                <select class="custom-select" id="inputGroupSelect03">
                  <option selected value="all">All</option>
                  <option value="own">Your Own</option>
                  <option value="none">None</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <script id="user-profile-template" type="text/x-handlebars-template">
            <h1>Logged in as {{display_name}}</h1>
            <div class="media">
              <div class="pull-left">
                <img class="media-object" width="150" src="{{images.0.url}}" />
              </div>
              <div class="media-body">
                <dl class="dl-horizontal">
                  <dt>Display name</dt><dd class="clearfix">{{display_name}}</dd>
                  <dt>Id</dt><dd>{{id}}</dd>
                </dl>
              </div>
            </div>
          </script>
      
          <script id="oauth-template" type="text/x-handlebars-template">
            <h2>oAuth info</h2>
            <dl class="dl-horizontal">
              <dt>Access token</dt><dd class="text-overflow">{{access_token}}</dd>
              <dt>Refresh token</dt><dd class="text-overflow">{{refresh_token}}</dd>
            </dl>
            
          </script>

          <script>
            (function() {
      
              /**
               * Obtains parameters from the hash of the URL
               * @return Object
               */
              function getHashParams() {
                var hashParams = {};
                var e, r = /([^&;=]+)=?([^&;]*)/g,
                    q = window.location.hash.substring(1);
                while ( e = r.exec(q)) {
                  hashParams[e[1]] = decodeURIComponent(e[2]);
                }
                return hashParams;
              }
      
              var userProfileSource = document.getElementById('user-profile-template').innerHTML,
                  userProfileTemplate = Handlebars.compile(userProfileSource),
                  userProfilePlaceholder = document.getElementById('user-profile');
      
              var oauthSource = document.getElementById('oauth-template').innerHTML,
                  oauthTemplate = Handlebars.compile(oauthSource),
                  oauthPlaceholder = document.getElementById('oauth');
      
              var params = getHashParams();
      
              var access_token = params.access_token,
                  refresh_token = params.refresh_token,
                  error = params.error;
      
              if (error) {
                alert('There was an error during the authentication');
              } else {
                if (access_token) {

                  $.ajax({
                      url: 'https://api.spotify.com/v1/me',
                      headers: {
                          'Authorization': 'Bearer ' + access_token
                      },
                      success: function(response) {
                          // Call your server endpoint /adduser here
                          $.ajax({
                              url: '/adduser', // Replace with the correct URL of your server endpoint
                              type: 'POST', // Adjust the HTTP method as needed
                              contentType: 'application/JSON',
                              data: JSON.stringify(response), // Pass the response data to your server
                              success: function(responseFromServer) {
                                  // Handle the response from your server if needed
                              },
                              error: function(xhr, status, error) {
                                  // Handle errors if the request to your server fails
                                  console.error("Request to add user failed.");
                                  console.error(error);
                              }
                          });
                      },
                      error: function(xhr, status, error) {
                          // Handle errors if the request to the Spotify API fails
                          console.error(error);
                      }
                  });
                } else {
                    // render initial screen
                    $('#login').show();
                    $('#loggedin').hide();
                }
      
                document.getElementById('obtain-new-token').addEventListener('click', function() {
                  $.ajax({
                    url: '/refresh_token',
                    data: {
                      'refresh_token': refresh_token
                    }
                  }).done(function(data) {
                    access_token = data.access_token;
                    oauthPlaceholder.innerHTML = oauthTemplate({
                      access_token: access_token,
                      refresh_token: refresh_token
                    });
                  });
                }, false);
              }
              window.onSpotifyWebPlaybackSDKReady = () => {
                const token = access_token;
                console.log(token);
                const player = new Spotify.Player({
                    name: 'Web Playback SDK Quick Start Player',
                    getOAuthToken: cb => { cb(token); },
                    volume: 0.5
                });

                // Ready
                player.addListener('ready', ({ device_id }) => {
                    console.log('Ready with Device ID', device_id);
                    setDevice(device_id, () => {
                      const progress = setInterval(getStatePosition, 100); // start the interval for getting the state's position after the device has been set
                    });
                });

                // Not Ready
                player.addListener('not_ready', ({ device_id }) => {
                    console.log('Device ID has gone offline', device_id);
                });

                player.addListener('initialization_error', ({ message }) => {
                    console.error(message);
                });

                player.addListener('authentication_error', ({ message }) => {
                    console.error(message);
                });

                player.addListener('account_error', ({ message }) => {
                    console.error(message);
                });

                var currState = {}
                player.addListener('player_state_changed', state => {
                  currState.paused = state.paused;
                  if(state.paused) {
                    document.getElementById('togglePlay').setAttribute("src", "./imgs/play2-removebg-preview.png");
                  }
                  else {
                    document.getElementById('togglePlay').setAttribute("src", "./imgs/pause-removebg-preview.png")
                  }
                  currState.position = state.position;
                  currState.duration = state.duration;
                  currState.updateTime = performance.now();
                  showCurrentlyPlaying();
                  updateBackground();
                });

                
                document.getElementById('previousTrack').onclick = async function() {
                  player.previousTrack();
                };

                document.getElementById('togglePlay').onclick = function() {
                  player.togglePlay();
                };

                document.getElementById('nextTrack').onclick = async function() {
                  await player.nextTrack();
                  showCurrentlyPlaying();
                };

                player.connect();

                async function updateBackground() {
                  const songFeatures = await getCurrentTrackFeatures();

                  var gradient = "linear-gradient(-45deg, ";
                  var newColors = [];

                  // get new colors
                  
                  var valence = songFeatures[1];
                  var energy = songFeatures[2];
                  var danceability = songFeatures[3];

                  if (valence > .5 && energy > .5 && danceability < .6) {
                    for (var i = 0; i < 4; i++) {
                      var newColor;
                      do {
                          newColor = getWarmColor();
                      } while (newColors.indexOf(newColor) !== -1);
                      newColors.push(newColor);
                    }
                  }
                  else if (valence > .5 && energy > .5 && danceability > .5) {
                    for (var i = 0; i < 4; i++) {
                      var newColor;
                      do {
                          newColor = getVibrantColor();
                      } while (newColors.indexOf(newColor) !== -1);
                      newColors.push(newColor);
                    }
                  }
                  else if (valence > .5 && energy < .5) {
                    for (var i = 0; i < 4; i++) {
                      var newColor;
                      do {
                          newColor = getPastelColor();
                      } while (newColors.indexOf(newColor) !== -1);
                      newColors.push(newColor);
                    }
                  }
                  else if (valence < .5 && energy < .5 && danceability < .5) {
                    for (var i = 0; i < 4; i++) {
                      var newColor;
                      do {
                          newColor = getCoolColor();
                      } while (newColors.indexOf(newColor) !== -1);
                      newColors.push(newColor);
                    }
                  }
                  else {
                    for (var i = 0; i < 4; i++) {
                      var newColor;
                      do {
                          newColor = getRandomColor();
                      } while (newColors.indexOf(newColor) !== -1);
                      newColors.push(newColor);
                    }
                  }

                  for (var i = 0; i < newColors.length; i++) {
                      gradient += newColors[i];
                      if (i !== newColors.length - 1) {
                          gradient += ", ";
                      }
                  }

                  gradient += ")";

                  document.body.style.background = gradient;

                  // add animation properties
                  document.body.style.backgroundSize = "400% 400%";

                  var animationSpeed = songFeatures[0];
                  animationSpeed = 650 / animationSpeed; // Adjusting animation speed based on tempo
                  document.getElementById("speed").textContent = 'Anim Speed: ' + animationSpeed;
                  document.body.style.backgroundSize = "400% 400%";
                  document.body.style.animation = "gradient " + animationSpeed + "s ease infinite";
                }


                function getRandomColor() {
                  var letters = '0123456789ABCDEF';
                  var color = '#';
                  for (var i = 0; i < 6; i++) {
                    color += letters[Math.floor(Math.random() * 16)];
                  }
                  return color;
                }

                // based on valence and energy
                function getWarmColor() {
                  var hue;
                  do {
                      hue = Math.floor(Math.random() * 360); 
                  } while (!((hue >= 0 && hue <= 30) || (hue >= 330 && hue <= 360))); // random hue between 0-30 or 300-360
                  
                  var saturation = Math.floor(Math.random() * 40) + 60; // random saturation between 50% and 100%
                  var lightness = Math.floor(Math.random() * 20) + 40; // random lightness between 50% and 80%
                  return hslToHex(hue, saturation, lightness);
                }

                function getCoolColor() {
                    var hue;
                    do {
                        hue = Math.floor(Math.random() * 360); // Random hue between 0° and 360°
                    } while (!((hue >= 150 && hue <= 270)));
                    
                    var saturation = Math.floor(Math.random() * 50) + 50; // random saturation between 50% and 100%
                    var lightness = Math.floor(Math.random() * 50) + 15; // random lightness between 50% and 80%
                    return hslToHex(hue, saturation, lightness);
                }

                function getPastelColor() {
                    var hue = Math.floor(Math.random() * 360); // Random hue between 0° and 360°
                    var saturation = Math.floor(Math.random() * 30) + 70; // Random saturation between 70% and 100%
                    var lightness = Math.floor(Math.random() * 15) + 75; // Random lightness between 50% and 100%
                    return hslToHex(hue, saturation, lightness);
                }

                function getVibrantColor() {
                    var hue = Math.floor(Math.random() * 360); // Random hue between 0° and 360°
                    var saturation = Math.floor(Math.random() * 30) + 70; // Random saturation between 70% and 100%
                    var lightness = Math.floor(Math.random() * 15) + 45; // Random lightness between 50% and 100%
                    return hslToHex(hue, saturation, lightness);
                }

                function hslToHex(h, s, l) {
                    h /= 360;
                    s /= 100;
                    l /= 100;
                    let r, g, b;
                    if (s === 0) {
                        r = g = b = l;
                    } else {
                        const hue2rgb = (p, q, t) => {
                            if (t < 0) t += 1;
                            if (t > 1) t -= 1;
                            if (t < 1 / 6) return p + (q - p) * 6 * t;
                            if (t < 1 / 2) return q;
                            if (t < 2 / 3) return p + (q - p) * (2 / 3 - t) * 6;
                            return p;
                        };
                        const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
                        const p = 2 * l - q;
                        r = hue2rgb(p, q, h + 1 / 3);
                        g = hue2rgb(p, q, h);
                        b = hue2rgb(p, q, h - 1 / 3);
                    }
                    const toHex = (x) => {
                        const hex = Math.round(x * 255).toString(16);
                        return hex.length === 1 ? '0' + hex : hex;
                    };
                    return `#${toHex(r)}${toHex(g)}${toHex(b)}`;
                }


                async function getCurrentTrackFeatures() {
                  const state = await player.getCurrentState();
                  if (!state) {
                    console.error('User is not playing music through the Web Playback SDK');
                    return;
                  }

                  const current_track_id = state.track_window.current_track.id;
                  var songFeatures = [];
                  var track_tempo = 0;
                  var track_valence = 0;
                  var track_energy = 0;
                  var track_danceability = 0;
                  var url = "";

                  await $.ajax({
                    url: 'https://api.spotify.com/v1/audio-features/' + current_track_id,
                    type: 'GET',
                    headers: {
                      'Authorization': 'Bearer ' + access_token
                    },
                    success: function(response) {
                      track_tempo = response.tempo;
                      document.getElementById("tempo").textContent = 'Tempo: ' + track_tempo;

                      track_valence = response.valence;
                      document.getElementById("valence").textContent = 'Valence: ' + track_valence;

                      track_energy = response.energy;
                      document.getElementById("energy").textContent = 'Energy: ' + track_energy;

                      track_danceability = response.danceability;
                      document.getElementById("danceability").textContent = 'Danceability: ' + track_danceability;

                      url = response.id;
                      document.getElementById("url").textContent = 'id: ' + url;
                    }
                  });

                  songFeatures[0] = track_tempo;
                  songFeatures[1] = track_valence;
                  songFeatures[2] = track_energy;
                  songFeatures[3] = track_danceability;
                  return songFeatures;
                }  

                // Function to update the timestamp and song's duration
                function updateTimestampAndDuration(position, duration) {
                  const currentTimeElement = document.getElementById('current-time');
                  const totalTimeElement = document.getElementById('total-duration');
                  
                  const currentTime = formatTime(position);
                  const totalTime = formatTime(duration);
                  
                  currentTimeElement.textContent = currentTime;
                  totalTimeElement.textContent = totalTime;
                }

                // Function to format time in MM:SS format
                function formatTime(time) {
                  const minutes = Math.floor(time / 1000 / 60);
                  const seconds = Math.floor(time / 1000 % 60);
                  return `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                }

                function getStatePosition() {
                  if (currState.paused) {
                    return currState.position ? currState.position : 0;
                  }
                  let position = currState.position + (performance.now() - currState.updateTime);
                  if (isNaN(position)) {
                    console.log('Position is NaN. Resetting position to 0.');
                    position = 0;
                  }
                  if (isNaN(currState.duration)) {
                    currState.duration = 0;
                  }
                  setProgressBar(position);
                  updateTimestampAndDuration(position, currState.duration);
                  return position > currState.duration ? currState.duration : position;
                }

                function setProgressBar(position) {
                  const progressBar = document.getElementById('progress-bar');
                  const duration = currState.duration;
                  const percentage = (position / duration) * 100;
                  progressBar.style.width = percentage + '%';
                }
          
                // ensures that the player is connected to spotify without the user having to manually connect it on a spotify application
                function setDevice(device_id, callback) {
                  $.ajax({
                    url: 'https://api.spotify.com/v1/me/player',
                    type: 'PUT',
                    data: JSON.stringify({ device_ids: [device_id] }),
                    headers: {
                      'Authorization': 'Bearer ' + access_token,
                      'Content-Type': 'application/json'
                    },
                    success: function(response) {
                      console.log('Device set for playback:', device_id);
                      callback(); // executes the setInterval which calls getStatePosition periodically
                    },
                    error: function(xhr, status, error) {
                      console.error('Error setting device:', error);
                    }
                  });
                }

                function showCurrentlyPlaying() {
                  player.getCurrentState().then(state => {
                  if (!state) {
                    console.error('User is not playing music through the Web Playback SDK');
                    return;
                  }

                  var current_track = state.track_window.current_track;
                  var next_track = state.track_window.next_tracks[0];

                  var artistNames = current_track.artists[0].name;
                  for (let i = 1; i < current_track.artists.length; i++) {
                    artistNames = artistNames.concat(", ", current_track.artists[i].name);
                  }
                  document.getElementById("currentlyPlaying").innerHTML = "".concat("Currently Playing: ", current_track.name).concat(" by ", artistNames); 
                  // Displaying the image of the current track
                  var albumImage = current_track.album.images[0].url;
                  var imageElement = document.getElementById("currentTrackImage");
                  if (albumImage) {
                    // If there is an image URL, display the image
                    imageElement.src = albumImage;
                    imageElement.alt = "Current Track Image";
                    imageElement.style.display = "inline"; // Show the image
                  } else {
                    // If there is no image URL, hide the image element
                    imageElement.style.display = "none";
                  }
                  });
                }

              }
            })();
          </script>
          <p id= "tempo" ></p>
          <p id= "valence" ></p>
          <p id= "energy" ></p>
          <p id= "danceability" ></p>
          <p id= "url" ></p>
          <p id= "speed" ></p>
      </main>
    
      <footer class="mt-auto text-white-50">
        <p>A Hot Dog Devs Production</p>
      </footer>
    </div>
</body>
</html>
