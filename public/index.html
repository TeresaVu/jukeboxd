
<!DOCTYPE html>
<html>
<head>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
  <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
  <script src="https://sdk.scdn.co/spotify-player.js"></script>

  <title>Jukeboxd Player</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="background-style.css">
  <script>
      //jQuery stuff
      $(document).ready(function(){

          var childDiv = $(".hiddenFormMouseover").hide()
              , throttle
              , fadingIn
          
          $(document).mousemove(function(event) {
              clearTimeout(throttle)

              if(!fadingIn) {
                  fadingIn = true
                  childDiv.stop(true).fadeIn(500, function () {
                      fadingIn = false
                  });
              }

              throttle = setTimeout(function () {
                  childDiv.fadeOut(500);                        
              }, 3000);
              
          });

          $(".hiddenFormMouseover").hover(function () {
              childDiv.show();
          });
      });
  </script>
</head>

<body class="d-flex h-100 text-center text-white bg-dark">
  <div class="cover-container d-flex w-100 h-100 p-3 mx-auto flex-column">
      <header class="mb-auto">
          <div>
              <nav class="nav nav-masthead justify-content-center float-md-start">
                  <div class="input-group">
                      <div class="input-group mb-3 searchbar hiddenFormMouseover">
                          <input type="text" class="form-control input-text" placeholder="Search songs..." aria-label="Song Name" aria-describedby="basic-addon1">
                          <div class="input-group-append">
                              <button class="btn btn-outline-primary btn-lg" type="button"><i class="fa fa-search"></i></button>
                          </div>
                      </div>
                  </div>
              </nav>
          </div>
      </header>
    
      <main class="px-3">
        <div id="loggedin">
          <div id="user-profile">
          </div>
          <div id="oauth">
          </div>
          <button class="btn btn-default" id="obtain-new-token"></button>
        </div>
        <button id="previousTrack">Previous Track</button>
        <button id="togglePlay">Toggle Play</button>
        <button id="nextTrack">Next Track</button>
        <br>
        <img id="currentTrackImage" src="" alt="">
        <p id="currentlyPlaying"></p><br>

        <script id="user-profile-template" type="text/x-handlebars-template">
            <h1>Logged in as {{display_name}}</h1>
            <div class="media">
              <div class="pull-left">
                <img class="media-object" width="150" src="{{images.0.url}}" />
              </div>
              <div class="media-body">
                <dl class="dl-horizontal">
                  <dt>Display name</dt><dd class="clearfix">{{display_name}}</dd>
                  <dt>Id</dt><dd>{{id}}</dd>
                  <!-- <dt>Email</dt><dd>{{email}}</dd> -->
                  <!-- <dt>Spotify URI</dt><dd><a href="{{external_urls.spotify}}">{{external_urls.spotify}}</a></dd> -->
                  <!-- <dt>Link</dt><dd><a href="{{href}}">{{href}}</a></dd>
                  <dt>Profile Image</dt><dd class="clearfix"><a href="{{images.0.url}}">{{images.0.url}}</a></dd>
                  <dt>Country</dt><dd>{{country}}</dd> -->
                </dl>
              </div>
            </div>
          </script>
      
          <script id="oauth-template" type="text/x-handlebars-template">
            <h2>oAuth info</h2>
            <dl class="dl-horizontal">
              <dt>Access token</dt><dd class="text-overflow">{{access_token}}</dd>
              <dt>Refresh token</dt><dd class="text-overflow">{{refresh_token}}</dd>
            </dl>
            
          </script>

          <script>
            (function() {
      
              /**
               * Obtains parameters from the hash of the URL
               * @return Object
               */
              function getHashParams() {
                var hashParams = {};
                var e, r = /([^&;=]+)=?([^&;]*)/g,
                    q = window.location.hash.substring(1);
                while ( e = r.exec(q)) {
                  hashParams[e[1]] = decodeURIComponent(e[2]);
                }
                return hashParams;
              }
      
              var userProfileSource = document.getElementById('user-profile-template').innerHTML,
                  userProfileTemplate = Handlebars.compile(userProfileSource),
                  userProfilePlaceholder = document.getElementById('user-profile');
      
              var oauthSource = document.getElementById('oauth-template').innerHTML,
                  oauthTemplate = Handlebars.compile(oauthSource),
                  oauthPlaceholder = document.getElementById('oauth');
      
              var params = getHashParams();
      
              var access_token = params.access_token,
                  refresh_token = params.refresh_token,
                  error = params.error;
      
              if (error) {
                alert('There was an error during the authentication');
              } else {
                if (access_token) {
                  // render oauth info
                  // oauthPlaceholder.innerHTML = oauthTemplate({
                  //   access_token: access_token,
                  //   refresh_token: refresh_token
                  // });
      
                  $.ajax({
                      url: 'https://api.spotify.com/v1/me',
                      headers: {
                        'Authorization': 'Bearer ' + access_token
                      },
                      success: function(response) {
                        userProfilePlaceholder.innerHTML = userProfileTemplate(response);
      
                        $('#login').hide();
                        $('#loggedin').show();
                      }
                  });
                } else {
                    // render initial screen
                    $('#login').show();
                    $('#loggedin').hide();
                }
      
                document.getElementById('obtain-new-token').addEventListener('click', function() {
                  $.ajax({
                    url: '/refresh_token',
                    data: {
                      'refresh_token': refresh_token
                    }
                  }).done(function(data) {
                    access_token = data.access_token;
                    oauthPlaceholder.innerHTML = oauthTemplate({
                      access_token: access_token,
                      refresh_token: refresh_token
                    });
                  });
                }, false);
              }
              window.onSpotifyWebPlaybackSDKReady = () => {
                const token = access_token;
                console.log(token);
                const player = new Spotify.Player({
                    name: 'Web Playback SDK Quick Start Player',
                    getOAuthToken: cb => { cb(token); },
                    volume: 0.5
                });

                // Ready
                player.addListener('ready', ({ device_id }) => {
                    console.log('Ready with Device ID', device_id);
                    setDevice(device_id);
                });

                // Not Ready
                player.addListener('not_ready', ({ device_id }) => {
                    console.log('Device ID has gone offline', device_id);
                });

                player.addListener('initialization_error', ({ message }) => {
                    console.error(message);
                });

                player.addListener('authentication_error', ({ message }) => {
                    console.error(message);
                });

                player.addListener('account_error', ({ message }) => {
                    console.error(message);
                });

                document.getElementById('previousTrack').onclick = async function() {
                  await player.previousTrack();
                  showCurrentlyPlaying();
                };

                document.getElementById('togglePlay').onclick = function() {
                  player.togglePlay();
                  showCurrentlyPlaying();
                };

                document.getElementById('nextTrack').onclick = async function() {
                  await player.nextTrack();
                  showCurrentlyPlaying();
                };

                player.connect();

                function setDevice(device_id) {
                  $.ajax({
                    url: 'https://api.spotify.com/v1/me/player',
                    type: 'PUT',
                    data: JSON.stringify({ device_ids: [device_id] }),
                    headers: {
                      'Authorization': 'Bearer ' + access_token,
                      'Content-Type': 'application/json'
                    },
                    success: function(response) {
                      console.log('Device set for playback:', device_id);
                    },
                    error: function(xhr, status, error) {
                      console.error('Error setting device:', error);
                    }
                  });
                }

                function showCurrentlyPlaying() {
                  player.getCurrentState().then(state => {
                  if (!state) {
                    console.error('User is not playing music through the Web Playback SDK');
                    return;
                  }

                  var current_track = state.track_window.current_track;
                  var next_track = state.track_window.next_tracks[0];

                  var artistNames = current_track.artists[0].name;
                  for (let i = 1; i < current_track.artists.length; i++) {
                    artistNames = artistNames.concat(", ", current_track.artists[i].name);
                  }
                  document.getElementById("currentlyPlaying").innerHTML = "".concat("Currently Playing ", current_track.name).concat(" by ", artistNames); 
                  // Displaying the image of the current track
                  var albumImage = current_track.album.images[0].url;
                  var imageElement = document.getElementById("currentTrackImage");
                  if (albumImage) {
                    // If there is an image URL, display the image
                    imageElement.src = albumImage;
                    imageElement.alt = "Current Track Image";
                    imageElement.style.display = "inline"; // Show the image
                  } else {
                    // If there is no image URL, hide the image element
                    imageElement.style.display = "none";
                  }
                });
                }
            }
            })();
          </script>
          <!-- Needs to be lowered a little on the page -->
          <!-- <p class="lead">(Song Name)</p>
          <p class="lead">(Pause/resume Button)</p> -->
          <p class="lead">(Song timestamp)</p>
          <label>Add Comment:</label><br>
          <input type="text" id="commentInput" style="border-radius: 20px; padding: 10px;" placeholder="Type here...">
      </main>
    
      <footer class="mt-auto text-white-50">
        <p>A Hot Dog Devs Production</p>
      </footer>
    </div>
</body>
</html>
